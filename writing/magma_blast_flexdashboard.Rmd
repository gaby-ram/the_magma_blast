---
title: "The Magma Blast Flex Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
```

```{r include=FALSE}
# load packages
library(tidyverse)
library(maps)
library(patchwork)
library(viridis)
library(hrbrthemes)
library(ggplot2)
library(ggthemes)
library(ggridges)
library(tigris)
library(sf)

library(lemon)
library(lubridate)
library(broom)
library(knitr)
library(scales)
library(viridis)
library(shiny)
library(leaflet)
library(DT)
library(plotly)
library(flexdashboard)
library(jsonlite)
library(maptools)
library(ggplot2)
library(dplyr)
```

```{r include=FALSE}
#Reading in the data
eruptions <- read_csv("../data/eruptions.csv")
events <- read_csv("../data/events.csv")
sulfur <- read_csv("../data/sulfur.csv")
tree_rings <- read_csv("../data/tree_rings.csv")
events <- read_csv("../data/events.csv")
volcano <- read_csv("../data/volcano.csv")
c_and_c <- read.csv("../data/continent_and_countries.csv") 
colnames(c_and_c) <- c("country", "continent")
head(eruptions)
```

Column {.sidebar}
--------------------------------------------------

Some fun text about why volcano eruptions are great to know about. Yaayyy!!!

Column {data-width=350}
-----------------------------------------------------------------------

### World

```{r}

```

### USA



```{r include=FALSE}

glimpse(volcano)
```

```{r include=FALSE}
# filter US data only
us_volc <- volcano %>% 
  filter(country == "United States")%>%
  filter(region %in% c( "Canada and Western USA", "Alaska", "Hawaii and Pacific Ocean"))
head(us_volc)
```


```{r include=FALSE}
# load map for US
usa <- map_data("world", region = "usa")

```

Change to an sf object by saying which columns are the coordinates and setting a CRS:
```{r}
usa_crs<- st_as_sf(us_volc, coords = c("longitude", "latitude")) %>%
st_set_crs(4269) #setting CRS
usa_crs %>% slice(1:3)
```

```{r include=FALSE}
# map with tigris
usa_tigris <-tracts( cb = TRUE, class = "sf")
class(usa_tigris)
```

```{r}
# ridgeline plot of elevation across subregions
p1 <- ggplot() +
  geom_density_ridges_gradient(
    data = usa_crs,
    aes(x = elevation, y = region, fill = stat(x))
  ) +
  scale_fill_viridis() +
  theme_minimal() +
  theme(
    legend.position = "none", 
    panel.grid = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank()
  )
p1
```
current problem is data points are positive longitude 
```{r}
# map of volcano locations, colour coded by elevation
p2 <- ggplot() +
  geom_polygon(
    data = usa,
    aes(x = long, y = lat, group = group),
    fill = "firebrick2",
    alpha = 1) +
  geom_sf(data = usa_crs, aes(color = elevation))+
  
  
  theme_void() 
p2
```
geom_point(
    data = us_crs,
    aes(x = longitude, y = latitude, colour = elevation),
    ) +
    scale_color_viridis() +
  labs(
    y = "latitude",
    x = "longitude")+


annotate("text", x = 141, y = 44, label = "Hokkaido") +
  annotate("text", x = 137, y = 38, label = "Honshu") +
  annotate("text", x = 127, y = 31, label = "Ryukyu Islands\n & Kyushu") +
  annotate("text", x = 142, y = 29, label = "Izu, Volcano\n & Mariana Islands") +
```{r}
# specify layout for patchwork  
layout <- c(
  area(1, 1, 2, 2),
  area(1.5, 1.5, 5, 5)
)
```


```{r}
# put it all together
p1 +
  p2 + 
  plot_layout(design = layout) +  
  plot_annotation(
  title = "Volcanoes in The United States",
  subtitle = "Elevation of change this",
  caption = "Data from The Smithsonian Institution"
) 

#ggsave(filename = "US_volcanoes.png")

```



Column {data-width=350}
-----------------------------------------------------------------------

### Time Series Plot

```{r}

```

### Interactive Table/Plot

```{r}
##cleaning eruption table
eruptions_clean <- eruptions %>% 
  filter(eruption_category == "Confirmed Eruption" & start_year >= 1700 & 
           evidence_method_dating %in% c("Historical Observations", "Seismicity")) %>% 
  select("volcano_number", "volcano_name", "eruption_number","eruption_category",
         "start_year", "end_year", "evidence_method_dating", "vei") %>% 
  drop_na() %>% group_by(volcano_name) %>% 
  mutate(number_of_events = n(), 
         max_vei = max(vei)) %>% 
  ungroup()
##cleaning volcano table
volcano_clean <- volcano %>% 
  select("population_within_100_km", "longitude", "latitude", 
         "country","region", "volcano_number", "volcano_name", 
         "primary_volcano_type")
##Joining tables based on cleaned eruption table
final_table <- eruptions_clean %>% 
  left_join(volcano_clean, by = "volcano_name") %>% 
  full_join(c_and_c, by = "country") %>% 
  mutate(volcano_name = fct_reorder(volcano_name, number_of_events),
         population = log10(population_within_100_km+1),
         long_lab = round(longitude, 0),
         long_lab_2 = ifelse(long_lab>0, paste0(long_lab, "N"), paste0(-long_lab, "S"))) %>% 
  filter(number_of_events > 5 & number_of_events < 10) %>% 
  drop_na()
final_table$primary_volcano_type <- str_replace_all(final_table$primary_volcano_type, 
                                                    c("Lava dome(s)" ="Lava dome",
                                                  "Stratovolcano(es)"= "Stratovolcano"))
long_lab_2 <- final_table$long_lab_2
```

```{r the_plot}
##Point Plot
left <- final_table %>% 
  ggplot()+
  geom_point(aes(x = start_year, y = volcano_name, size = vei, 
                 color = continent), alpha = 0.7, stroke=1.2)+
  scale_size_area(breaks=c(1,2,3,4,5,6), max_size = 12,name = "Volcano \nExplosivity \nIndex")+
  scale_color_brewer(palette="Dark2", name = "Location (Continent)")+
  scale_x_continuous(breaks=seq(1700, 2020, 40)) +
  scale_y_discrete(expand=c(0.025,0.025))+
  labs(x='', y='')+
  theme_get()+
  guides(color = guide_legend(override.aes = list(size = 10)))+
  theme(legend.position = 'bottom', 
        legend.key = element_blank(),
        legend.title = element_text(face="bold", colour = "black"),
        panel.grid.major.y = element_line(colour= 'black'),
        panel.grid.major.x = element_line(colour = "white"),
        panel.border = element_blank(),
        axis.text = element_text(size=10, colour='black'),
        title = element_text(colour='black', size=14, face='bold', hjust=0),
        plot.subtitle = element_text(colour='white', size=9, face='bold', hjust=0),
        plot.background = element_rect(color='white',fill = "white"),
        panel.background = element_rect(fill = "white",
                                        colour = "white",
                                        linewidth = 5, linetype = "solid"),
        plot.margin=unit(c(0.5, 0.2, 0, 0), 'cm'))+
  ggtitle("Catasprophic Eruptions since 1700")
```

```{r plot_2}
##Bar Chart
right <- final_table %>% 
  group_by(volcano_name, population, primary_volcano_type, country, long_lab_2) %>% 
  summarise(count= n()) %>% 
  ungroup() %>% 
  ggplot()+
  geom_col(aes(x = volcano_name, y = population, 
               fill = primary_volcano_type))+
  geom_text(aes(x = volcano_name, y = population, label = country), size = 3.5,
            hjust = -0.2, color = "black")+
  scale_fill_discrete(name = "Volcano Type")+
  theme_get()+
  guides(fill=guide_legend(ncol=3))+
  theme(legend.position = "bottom",
        legend.key = element_blank(),
        axis.text.y = element_text(size=10, colour='black', hjust=0.5),
        axis.text.x = element_text(size=10, colour='black'),
        axis.line.x = element_line(color='black'),
        plot.background = element_rect(color='white', fill = "white"),
        title = element_text(colour='black', size=14, face='bold', hjust=0),
        panel.border = element_blank(),
        plot.subtitle = element_text(colour='white', size=9, face='bold', hjust=0),
        panel.background = element_rect(fill = "white",
                                    colour = "white",
                                    size = 0.5, linetype = "solid"),
        plot.margin=unit(c(0.5, 1, 0.2, -0.5), 'cm'))+
  coord_flip()+
  labs(x='', y='Population within 100km of Volcano')+
  scale_y_continuous(expand = c(0, 0), breaks=seq(0, 10, 2.5)) +
  scale_x_discrete(expand=c(0.025,0.025), label = long_lab_2) +
  ggtitle("Population and Country")
```

```{r fig.dim = c(20, 15)}
cowplot::plot_grid(left, right, rel_widths = c(1, 0.5), nrow=1,  label_size=15)
```

