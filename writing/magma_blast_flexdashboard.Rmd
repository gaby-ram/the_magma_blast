---
title: "The Magma Blast Flex Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
```

```{r include=FALSE}
# load packages
library(tidyverse)
library(maps)
library(patchwork)
library(viridis)
library(hrbrthemes)
library(ggplot2)
library(ggthemes)
library(ggridges)
library(tigris)
library(sf)


library(lubridate)
library(broom)
library(knitr)
library(scales)
library(viridis)
library(shiny)
library(leaflet)
library(DT)
library(plotly)
library(flexdashboard)
library(jsonlite)
library(maptools)
library(ggplot2)
library(usmap)
```

```{r include=FALSE}
#Reading in the data
eruptions <- read_csv("../data/eruptions.csv")
events <- read_csv("../data/events.csv")
sulfur <- read_csv("../data/sulfur.csv")
tree_rings <- read_csv("../data/tree_rings.csv")
events <- read_csv("../data/events.csv")
volcano <- read_csv("../data/volcano.csv")
head(eruptions)
```
 
Column {.sidebar}
--------------------------------------------------

Some fun text about why volcano eruptions are great to know about. Yaayyy!!!

Column {data-width=350}
-----------------------------------------------------------------------

### World

```{r}

```

### USA



```{r include=FALSE}

glimpse(volcano)
```






```{r include=FALSE}

glimpse(volcano)
```

```{r include=FALSE}
# filter US data only
usa_volc <- volcano %>% 
  filter(country == "United States")%>%
  filter(region %in% c( "Canada and Western USA", "Alaska", "Hawaii and Pacific Ocean"))%>%
  mutate(region = factor(region, levels = c("Canada and Western USA", 
                                                      "Alaska", 
                                                      "Hawaii and Pacific Ocean"), 
                      labels = c("Western USA", "Alaska", "Hawaii")))
  
```

	
```{r}
usa_volc[64, 9] = -180.42
usa_volc[14, 9] = -184.089
```


```{r include=FALSE}
# load map for US
usa <- map_data("world", region = "usa", class = "sf")


```

Change to an sf object by saying which columns are the coordinates and setting a CRS:
```{r}
usa_crs<- st_as_sf(usa_volc, coords = c("longitude", "latitude")) %>%
  st_set_crs(4269) #setting CRS
usa_crs %>% slice(1:3)
```


```{r}
# ridgeline plot of elevation across regions
p1 <- ggplot() +
  geom_density_ridges_gradient(
    data = usa_volc,
    aes(x = elevation, y = region, fill = stat(x))
  ) +
  scale_fill_viridis() +
  theme_minimal() +
  theme(
    legend.position = "none", 
    panel.grid = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank()
  )
p1
```

using original code again
```{r}
# map of volcano locations, colour coded by elevation
p2 <- ggplot() +
  geom_polygon(
    data = usa,
    aes(x = long, y = lat, group = group),
    color = "gray25",
    fill = "tomato4",
    alpha = 0.6
  ) +
  xlim(c(-186, -65)) + ylim(c(18, 72))+
  geom_point(
    data = usa_volc,
    aes(x = longitude, y = latitude, colour = elevation),
  ) +
  scale_color_viridis() +
  labs(
    y = "latitude",
    x = "longitude")+
  annotate("text", x = 141, y = 44, label = "Hawaii") +
  annotate("text", x = 137, y = 38, label = "Western USA") +
  annotate("text", x = 127, y = 31, label = "Alaska") +
  annotate("text", x = 142, y = 29, label = "Izu, Volcano\n & Mariana Islands") +
  
  theme_void()+
  theme(panel.background = element_rect(color = "black", fill = "lavender"))
p2

```



```{r}
# specify layout for patchwork  
layout <- c(
  area(0.5, 0.5, 1, 1),
  area(1.5, 1.5, 5, 5)
)
```


```{r}
# put it all together
p1 +
  p2 + 
  plot_layout(design = layout) +  
  plot_annotation(
    title = "Volcanoes in The United States",
    subtitle = "Elevation of change this",
    caption = "Data from The Smithsonian Institution"
  ) 

#ggsave(filename = "US_volcanoes.png")

```




Column {data-width=350}
-----------------------------------------------------------------------

### Time Series Plot

```{r}

```

### Interactive Table/Plot

```{r}
##cleaning eruption table
eruptions_clean <- eruptions %>% 
  filter(eruption_category == "Confirmed Eruption" & start_year >= 1700 & 
           evidence_method_dating %in% c("Historical Observations", "Seismicity")) %>% 
  select("volcano_number", "volcano_name", "eruption_number","eruption_category",
         "start_year", "end_year", "evidence_method_dating", "vei") %>% 
  drop_na() %>% group_by(volcano_name) %>% 
  mutate(number_of_events = n(), 
         max_vei = max(vei)) %>% 
  ungroup()
##cleaning volcano table
volcano_clean <- volcano %>% 
  select("population_within_100_km", "longitude", "latitude", 
         "country","region", "volcano_number", "volcano_name", 
         "primary_volcano_type")
##Joining tables based on cleaned eruption table
final_table <- eruptions_clean %>% 
  left_join(volcano_clean, by = "volcano_name") %>% 
  mutate(volcano_name = fct_reorder(volcano_name, number_of_events)) %>% 
  filter(number_of_events > 19) %>% 
  drop_na()
```

```{r the_plot}
final_table %>% 
  ggplot()+
  geom_point(aes(x = start_year, y = volcano_name, size = max_vei))
final_table %>% 
  ggplot()+
  geom_col(aes(x = volcano_name, y = population_within_100_km))+
  coord_flip()
```

